@page "/orders"
@using Pitzam.Models
@inject Pitzam.Services.OrderStateService OrderState
@inject Pitzam.Services.AuthService Auth
@implements IDisposable

<div class="container py-4">
    <h2 class="mb-4">üì¶ Sipari≈ülerim</h2>

    @if (!isAuthenticated)
    {
        <div class="alert alert-warning">Sipari≈ülerinizi g√∂rmek i√ßin l√ºtfen giri≈ü yapƒ±n.</div>
        <a class="btn btn-primary" href="/login">Giri≈ü Yap</a>
    }
    else if (orders == null || orders.Count == 0)
    {
        <div class="alert alert-info">Hen√ºz tamamlanmƒ±≈ü sipari≈üiniz bulunmuyor.</div>
        <a class="btn btn-secondary" href="/">Men√ºye D√∂n</a>
    }
    else
    {
        <div class="row g-3">
            @foreach (var o in orders)
            {
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-semibold">@o.PizzaName</div>
                                <div class="text-muted small">Sipari≈ü No: @o.OrderNumber</div>
                                @if (!string.IsNullOrEmpty(o.Size))
                                {
                                    <div class="text-muted small">Boyut: @o.Size</div>
                                }
                            </div>
                            <div class="h5 m-0">@o.TotalPrice.ToString("C")</div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<Order> orders = new();
    private bool isAuthenticated;

    protected override async Task OnInitializedAsync()
    {
        // Auth durumunu y√ºkle ve sipari≈üleri getir
        await Auth.LoadCurrentUserAsync();
        isAuthenticated = Auth.IsAuthenticated;
        if (isAuthenticated)
        {
            orders = await OrderState.GetOrderHistoryAsync();
        }
        // Giri≈ü/√ßƒ±kƒ±≈ü deƒüi≈üimlerini dinle
        Auth.OnAuthStateChanged += HandleAuthChanged;
    }

    private async void HandleAuthChanged()
    {
        isAuthenticated = Auth.IsAuthenticated;
        if (isAuthenticated)
        {
            orders = await OrderState.GetOrderHistoryAsync();
        }
        else
        {
            orders = new List<Order>();
        }
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Auth.OnAuthStateChanged -= HandleAuthChanged;
    }
}


