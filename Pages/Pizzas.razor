@page "/"
@page "/pizzas"
@inject Pitzam.Services.PizzaService PizzaService

<h3 class="text-center mb-4">üçï Men√º</h3>

<div class="row">

    @* --------------------------------- *@
    @* S√úTUN 1: Fƒ∞LTRELEME MEN√úS√ú       *@
    @* --------------------------------- *@
    <div class="col-lg-3 col-md-4 mb-4">
        @* YENƒ∞: Component'i burada √ßaƒüƒ±rƒ±yoruz *@
        <IngredientFilter AllIngredients="allIngredients" OnFilterChanged="HandleFilterUpdate" />
    </div>

    @* --------------------------------- *@
    @* S√úTUN 2: Pƒ∞ZZA Lƒ∞STESƒ∞          *@
    @* --------------------------------- *@
    <div class="col-lg-9 col-md-8 ps-lg-4 ps-md-3">
        @if (filteredPizzas == null)
        {
            <p>Y√ºkleniyor...</p>
        }
        else if (!filteredPizzas.Any())
        {
            <div class="alert alert-warning text-center" role="alert">
                Se√ßili filtrelere uygun pizza bulunamadƒ±.
            </div>
        }
        else
        {
            <div class="row gy-4 row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4">
                @foreach (var pizza in filteredPizzas)
                {
                    <div class="col">
                        <div class="card shadow-sm h-100 pizza-card">
                            <img src="@pizza.ImageUrl" class="card-img-top pizza-image" alt="@pizza.Name" />
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">@pizza.Name</h5>
                                <p class="card-text text-muted small ingredients-list">
                                    @string.Join(", ", pizza.Ingredients)
                                </p>
                                <div class="mt-auto">
                                    <p class="card-text h5 text-primary mt-2">
                                        <b>@pizza.BasePrice TL</b>
                                    </p>
                                    <div class="btn-group w-100" role="group">
                                        <a class="btn btn-sm btn-outline-primary" href="/pizzas/@pizza.Id">
                                            <i class="bi bi-search"></i> Detay
                                        </a>
                                        <a class="btn btn-sm btn-success" href="/pizzas/@pizza.Id">
                                            <i class="bi bi-cart-plus"></i> Sepete Ekle
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>


@code {
    // Pizzalarƒ±n tam listesini tutar
    private List<Pitzam.Models.Pizza>? pizzas;

    // Sadece ekranda g√∂sterilecek filtrelenmi≈ü listeyi tutar
    private List<Pitzam.Models.Pizza>? filteredPizzas;

    // Filtre component'ine g√∂nderilecek t√ºm benzersiz malzemeler
    private List<string> allIngredients = new List<string>();

    // Filtre component'inden gelen se√ßili malzemeler
    private HashSet<string> selectedIngredients = new HashSet<string>();

    protected override async Task OnInitializedAsync()
    {
        pizzas = await PizzaService.GetPizzasAsync();
        if (pizzas != null)
        {
            ExtractAllIngredients();
            FilterPizzas(); // Ba≈ülangƒ±√ßta t√ºm pizzalarƒ± g√∂ster
        }
    }

    /// <summary>
    /// T√ºm pizzalarƒ± tarayarak benzersiz bir malzeme listesi olu≈üturur.
    /// </summary>
    private void ExtractAllIngredients()
    {
        if (pizzas == null) return;

        var ingredientsSet = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        foreach (var pizza in pizzas)
        {
            foreach (var ingredient in pizza.Ingredients)
            {
                ingredientsSet.Add(ingredient.Trim());
            }
        }
        
        // Alfabetik olarak sƒ±rala
        allIngredients = ingredientsSet.OrderBy(x => x).ToList();
    }

    /// <summary>
    /// YENƒ∞: IngredientFilter component'inden gelen olayƒ± (event) yakalar.
    /// </summary>
    private void HandleFilterUpdate(HashSet<string> newSelectedIngredients)
    {
        selectedIngredients = newSelectedIngredients;
        FilterPizzas();
    }

    /// <summary>
    /// 'pizzas' listesini 'selectedIngredients' listesine g√∂re filtreler
    /// ve sonucu 'filteredPizzas' listesine atar.
    /// (Bu metodun i√ßeriƒüi deƒüi≈ümedi)
    /// </summary>
    private void FilterPizzas()
    {
        if (pizzas == null) return;

        if (selectedIngredients.Count == 0)
        {
            filteredPizzas = pizzas;
        }
        else
        {
            filteredPizzas = pizzas.Where(pizza =>
                selectedIngredients.All(selectedIng =>
                    pizza.Ingredients.Contains(selectedIng, StringComparer.OrdinalIgnoreCase)
                )
            ).ToList();
        }
    }
}