@page "/settings"
@inject Pitzam.Services.AuthService Auth

<div class="container py-4">
    <h2 class="mb-4">⚙️ Ayarlar</h2>

    @if (!isAuthenticated)
    {
        <div class="alert alert-warning">Ayarları görmek için giriş yapın.</div>
        <a class="btn btn-primary" href="/login">Giriş Yap</a>
    }
    else
    {
        @if (!string.IsNullOrEmpty(message))
        {
            <div class="alert @messageCss">@message</div>
        }

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white"><strong>Şifre Değiştir</strong></div>
            <div class="card-body">
                <EditForm Model="passwordModel" OnValidSubmit="ChangePassword">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Mevcut Şifre</label>
                            <InputText class="form-control" type="password" @bind-Value="passwordModel.CurrentPassword" />
                            <ValidationMessage For="@(() => passwordModel.CurrentPassword)" />
                        </div>
                        <div class="col-12">
                            <label class="form-label">Yeni Şifre</label>
                            <InputText class="form-control" type="password" @bind-Value="passwordModel.NewPassword" />
                            <ValidationMessage For="@(() => passwordModel.NewPassword)" />
                        </div>
                        <div class="col-12">
                            <label class="form-label">Yeni Şifre (Tekrar)</label>
                            <InputText class="form-control" type="password" @bind-Value="passwordModel.ConfirmPassword" />
                            <ValidationMessage For="@(() => passwordModel.ConfirmPassword)" />
                        </div>
                    </div>

                    <div class="mt-3">
                        <button class="btn btn-primary" type="submit">Şifreyi Güncelle</button>
                    </div>
                </EditForm>
            </div>
        </div>
    }
</div>

@code {
    private bool isAuthenticated;
    private string? message;
    private string messageCss = "alert-success";

    private class PasswordModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Mevcut şifre zorunludur")]
        public string CurrentPassword { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.StringLength(100, MinimumLength = 6)]
        public string NewPassword { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Compare("NewPassword", ErrorMessage = "Şifreler eşleşmiyor")] 
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    private PasswordModel passwordModel = new();

    protected override async Task OnInitializedAsync()
    {
        await Auth.LoadCurrentUserAsync();
        isAuthenticated = Auth.IsAuthenticated;
    }

    private async Task ChangePassword()
    {
        if (!isAuthenticated || Auth.CurrentUser == null)
        {
            messageCss = "alert-danger";
            message = "Lütfen giriş yapın.";
            return;
        }

        if (string.IsNullOrWhiteSpace(passwordModel.NewPassword))
        {
            messageCss = "alert-danger";
            message = "Yeni şifre boş olamaz.";
            return;
        }

        var result = await Auth.ChangePasswordAsync(Auth.CurrentUser.Id, passwordModel.CurrentPassword, passwordModel.NewPassword);
        if (result.Success)
        {
            messageCss = "alert-success";
            message = result.Message;
            passwordModel = new();
        }
        else
        {
            messageCss = "alert-danger";
            message = result.Message;
        }
    }
}


