@using Pitzam.Models

<div class="customizer">
    <h3>@Pizza.Name Özelleştirme</h3>

    <!-- BOYUT SEÇİMİ -->
    <label>Boyut Seç:</label>
    <select @bind="SelectedSizeId">
        @foreach (var size in Pizza.Sizes)
        {
            <option value="@size.Id">@size.Name</option>
        }
    </select>

    <!-- EK MALZEMELER -->
    <h5>Ek Malzemeler (10 TL):</h5>
    @foreach (var extra in ExtraIngredients)
    {
        <label>
            <input type="checkbox" @bind="extra.Selected" /> @extra.Name
        </label><br />
    }

    <!-- ÇIKARILACAK MALZEMELER -->
    <h5>Çıkarılacak Malzemeler:</h5>
    @foreach (var ing in Pizza.Ingredients)
    {
        <label>
            <input type="checkbox" @onchange="e => ToggleRemove(ing, e)" /> @ing
        </label><br />
    }

    <p><b>Toplam Fiyat: @TotalPrice TL</b></p>

    <button class="btn" @onclick="ConfirmOrder">Siparişi Tamamla</button>
</div>

@code {
    // PARAMETRELER
    [Parameter] public Pizza Pizza { get; set; } = new();
    [Parameter] public EventCallback<Order> OnOrderReady { get; set; }

    // ALANLAR
    private string _selectedSizeId = "";
    private decimal _totalPrice;
    private List<string> RemovedIngredients = new();

    // PROPERTY (bind ile değişince fiyatı hesaplar)
    private string SelectedSizeId
    {
        get => _selectedSizeId;
        set
        {
            _selectedSizeId = value;
            CalculatePrice();
        }
    }

    private decimal TotalPrice
    {
        get => _totalPrice;
        set
        {
            _totalPrice = value;
        }
    }

    // EKSTRA MALZEMELER MODELİ
    public class ExtraIngredient
    {
        public string Name { get; set; } = "";
        public bool Selected { get; set; } = false;
    }

    private List<ExtraIngredient> ExtraIngredients = new()
    {
        new ExtraIngredient { Name = "Mantar" },
        new ExtraIngredient { Name = "Zeytin" },
        new ExtraIngredient { Name = "Sucuk" }
    };

    // INITIALIZE
    protected override void OnInitialized()
    {
        SelectedSizeId = Pizza.Sizes.First().Id;
        CalculatePrice();
    }

    // FİYAT HESAPLAMA
    private void CalculatePrice()
    {
        var size = Pizza.Sizes.First(s => s.Id == SelectedSizeId);
        int extras = ExtraIngredients.Count(e => e.Selected);
        TotalPrice = Pizza.BasePrice * (decimal)size.Multiplier + extras * 10;
    }

    // MALZEME ÇIKARMA
    private void ToggleRemove(string ingredient, ChangeEventArgs e)
    {
        bool isChecked = e.Value is bool b && b;
        if (isChecked)
            RemovedIngredients.Add(ingredient);
        else
            RemovedIngredients.Remove(ingredient);
    }

    // SİPARİŞ TAMAMLAMA
    private async Task ConfirmOrder()
    {
        var order = new Order
        {
            PizzaName = Pizza.Name,
            Size = Pizza.Sizes.First(s => s.Id == SelectedSizeId).Name,
            Extras = ExtraIngredients.Where(e => e.Selected).Select(e => e.Name).ToList(),
            RemovedIngredients = RemovedIngredients,
            TotalPrice = TotalPrice
        };

        await OnOrderReady.InvokeAsync(order);
    }
}
