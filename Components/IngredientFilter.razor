@* Bu component, dışarıdan bir malzeme listesi alır (AllIngredients)
   ve filtre değiştiğinde (OnFilterChanged) seçili malzemeleri dışarıya bildirir.
*@

<div class="card shadow-sm filter-card">
    <div class="card-body">
        <h5 class="card-title mb-3">
            <i class="bi bi-funnel-fill"></i> Filtrele
        </h5>

        @* Malzeme Arama Kutusu *@
        <div class="input-group input-group-sm mb-3">
            <span class="input-group-text" id="basic-addon1">
                <i class="bi bi-search"></i>
            </span>
            <input type="text"
                   class="form-control"
                   placeholder="Malzeme ara..."
                   aria-label="Malzeme ara"
                   @oninput="HandleSearchInput" />
        </div>

        <h6 class="filter-subtitle">Malzemeler</h6>
        <ul class="list-unstyled filter-list">
            @foreach (var ingredient in FilteredIngredients)
            {
                <li>
                    <div class="form-check">
                        <input class="form-check-input"
                               type="checkbox"
                               value="@ingredient"
                               id="check-@ingredient"
                               @onchange="(e) => ToggleIngredient(ingredient, (bool)e.Value)">

                        <label class="form-check-label" for="check-@ingredient">
                            @ingredient
                        </label>
                    </div>
                </li>
            }
        </ul>
    </div>
</div>

@code {
    /// <summary>
    /// Ana sayfadan (Pizzas.razor) gelen tüm benzersiz malzeme listesi.
    /// </summary>
    [Parameter]
    public List<string> AllIngredients { get; set; } = new List<string>();

    /// <summary>
    /// Kullanıcı bir malzeme seçtiğinde tetiklenir ve seçili malzemeleri
    /// ana sayfaya geri gönderir.
    /// </summary>
    [Parameter]
    public EventCallback<HashSet<string>> OnFilterChanged { get; set; }

    // --- Component'in Kendi İç Durumları ---

    private string ingredientSearchTerm = "";

    // Kullanıcının bu component içinde seçtiği aktif filtreler
    private HashSet<string> selectedIngredients = new HashSet<string>();
    
    // Arama metnine göre filtrelenmiş malzemeler
    private List<string> FilteredIngredients => AllIngredients
        .Where(ingredient =>
            string.IsNullOrWhiteSpace(ingredientSearchTerm) ||
            ingredient.Contains(ingredientSearchTerm, StringComparison.OrdinalIgnoreCase))
        .ToList();

    /// <summary>
    /// Arama kutusu her değiştiğinde bu metodu çağırır.
    /// </summary>
    private void HandleSearchInput(ChangeEventArgs e)
    {
        ingredientSearchTerm = e.Value?.ToString() ?? "";
    }

    /// <summary>
    /// Bir malzeme filtresi seçildiğinde veya kaldırıldığında tetiklenir.
    /// </summary>
    private async Task ToggleIngredient(string ingredient, bool isChecked)
    {
        if (isChecked)
        {
            selectedIngredients.Add(ingredient);
        }
        else
        {
            selectedIngredients.Remove(ingredient);
        }

        // Değişikliği ana sayfaya (Pizzas.razor) bildirir.
        await OnFilterChanged.InvokeAsync(selectedIngredients);
    }
}